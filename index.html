<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Balbi Faucet</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <!-- Favicon (ajuste o href se quiser usar outro arquivo) -->
  <link rel="icon" type="image/png" sizes="32x32" href="logo1.png">
  <style>
    :root{
      --bg1:#0a1022; --bg2:#0d1b34;
      --accent:#2b6cb0; --accent2:#63b3ed; --accent3:#8ec7ff;
      --text:#e6eefb; --muted:#a5b4cf; --radius:18px;
      --hexOpacity:.08;
    }
    html,body{height:100%}
    body{
      margin:0; font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
      color:var(--text);
      background:
        radial-gradient(1100px 520px at 10% -10%, rgba(43,108,176,.10) 0%, transparent 60%),
        radial-gradient(900px 420px at 110% 120%, rgba(99,179,237,.10) 0%, transparent 62%),
        linear-gradient(180deg,var(--bg1),var(--bg2));
      display:flex; align-items:center; flex-direction:column; gap:16px;
      padding:24px 18px 28px; overflow-x:hidden;
    }

    /* INTRO (abertura) — cobre a página inteira e aparece sozinha */
    .intro{
      position:fixed; inset:0; width:100%; height:100dvh;
      display:grid; place-items:center;
      z-index:10000;
      background: linear-gradient(140deg, var(--bg1), var(--bg2), var(--bg1));
      background-size: 240% 240%;
      animation:
        introFade 1.8s ease forwards,
        bgMove 24s ease-in-out infinite;
    }
    .intro::before{
      content:""; position:absolute; inset:0;
      background: radial-gradient(1200px 700px at 50% -20%, rgba(99,179,237,.12), transparent 70%);
      pointer-events:none;
    }
    @keyframes introFade{ 0%{opacity:1} 85%{opacity:1} 100%{opacity:0; visibility:hidden} }
    @keyframes bgMove{ 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }

    .intro-wrap{
      width:clamp(160px, 26vmin, 320px);
      aspect-ratio:1/1; position:relative;
      transform: translateY(-16vh);
      animation:introPop .9s cubic-bezier(.2,.8,.2,1) forwards;
    }
    @keyframes introPop{
      0%{opacity:0; transform:translateY(-16vh) scale(.6) rotate(-8deg)}
      60%{opacity:1; transform:translateY(-16vh) scale(1.06)}
      100%{transform:translateY(-16vh) scale(1)}
    }
    .intro svg{width:100%; height:100%}
    .intro .hx-outline{stroke:url(#introStroke); stroke-width:8; fill:none; stroke-linejoin:round; filter:drop-shadow(0 8px 28px rgba(99,179,237,.25))}
    .intro .vertex{fill:url(#introStroke)}
    .intro image{clip-path:url(#introClip)}
    .intro .dash{stroke:#8ec7ff; stroke-width:3; fill:none; stroke-dasharray:20 90; animation:introDash 1.8s linear forwards}
    @keyframes introDash{ to{ stroke-dashoffset:-140 } }

    /* HEX de fundo */
    .hex-drift{position:fixed; inset:0; z-index:0; pointer-events:none; overflow:hidden}
    .hex{position:absolute; width:220px; aspect-ratio:1/1; opacity:var(--hexOpacity)}
    .hex svg{width:100%; height:100%}
    .hex use{stroke:url(#hexStroke); stroke-width:2; fill:none; filter:drop-shadow(0 0 6px rgba(99,179,237,.08))}
    .h1{top:10%; left:-20%; animation:float 28s linear infinite}
    .h2{top:60%; left:80%;  animation:float 32s linear infinite reverse}
    .h3{top:22%; left:45%;  animation:float 36s linear infinite}
    .h4{top:78%; left:-10%; animation:float 30s linear infinite reverse}
    @keyframes float{
      0%{transform:translateX(-10vw) translateY(0) rotate(0deg) scale(.92)}
      50%{transform:translateX(20vw) translateY(-8vh) rotate(180deg) scale(1)}
      100%{transform:translateX(60vw) translateY(4vh) rotate(360deg) scale(.92)}
    }

    .layer{position:relative; z-index:1; width:min(520px,94vw); margin:0 auto}
    .card{
      border-radius:var(--radius);
      background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.02));
      border:1px solid rgba(47,82,152,.35);
      box-shadow:0 16px 44px rgba(8,14,35,.55), inset 0 1px 0 rgba(255,255,255,.05);
      padding:26px 20px 22px;
    }

    .hero{display:grid; place-items:center; gap:10px; margin-bottom:12px}
    .logo-wrap{width:min(150px,54vw,40dvh); aspect-ratio:1/1}
    .logo-wrap svg{width:100%; height:100%}
    .hx-main{stroke:url(#stroke); stroke-width:7; fill:none; stroke-linejoin:round}
    .hx-dash{stroke:#8ec7ff; stroke-width:3; fill:none; stroke-dasharray:22 82; opacity:.9; animation:dash 9s linear infinite}
    @keyframes dash{to{stroke-dashoffset:-104}}
    .vertex{fill:url(#stroke)}
    .title{font-weight:800; font-size:28px; color:#b3d9ff; text-shadow:0 0 10px rgba(99,179,237,.55); margin:0}
    .subtitle{color:var(--muted); margin:0 8px 16px; text-align:center}

    /* Inputs */
    #privateKeyInput{
      width:100%; padding:12px; margin:0 0 14px; outline:none; color:#fff;
      background:rgba(255,255,255,.06); border:1px solid rgba(61,106,196,.5);
      box-shadow:inset 0 0 0 1px rgba(255,255,255,.04);
      border-radius:12px; font-size:16px; box-sizing:border-box;
    }
    #privateKeyInput::placeholder{color:#c7d6f0aa}
    #privateKeyInput:focus{border-color:#63b3ed; box-shadow:0 0 0 3px #63b3ed33, inset 0 0 0 1px rgba(255,255,255,.06)}

    #connectButton{
      width:100%; padding:12px; border:none; color:#fff; font-weight:800;
      background:linear-gradient(90deg,#2b6cb0,#63b3ed);
      text-transform:uppercase; letter-spacing:.08em;
      box-shadow:0 10px 22px rgba(43,108,176,.35); position:relative; overflow:hidden;
      border-radius:12px; font-size:16px; box-sizing:border-box; cursor:pointer;
    }
    #connectButton::after{
      content:""; position:absolute; inset:0;
      background:linear-gradient(120deg,transparent 0 32%, rgba(255,255,255,.22) 50%, transparent 70%);
      transform:translateX(-100%); transition:transform .65s ease;
    }
    #connectButton:hover::after{transform:translateX(100%)}

    .wallet-address{
      display:none; margin-top:14px; font-size:14px; color:#cfe4ff; word-break:break-all;
      padding:10px; border-radius:10px; border:1px solid #335aa8cc; background:rgba(255,255,255,.05)
    }
    #logoutButton{
      margin-top:10px; padding:6px 12px; font-size:12px; color:#fff; border:none; border-radius:8px;
      background:linear-gradient(90deg,#ef4444,#f43f5e); cursor:pointer;
    }

    .panel{background:rgba(255,255,255,.05); border-radius:14px; padding:18px; box-shadow:inset 0 0 18px rgba(43,108,176,.12)}
    .panel h2{margin:0 0 10px; font-size:18px; color:#8ec7ff}
    .balance-item{display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid #2f529833}
    .balance-item:last-child{border-bottom:0}
    .balance-value{font-weight:800; color:#8ec7ff}

    /* Claim: cinza inativo, verde ativo */
    #claimButton{
      width:100%; margin-top:6px; padding:14px; font-size:18px; border-radius:12px; border:none;
      position:relative; overflow:hidden; box-sizing:border-box;
      background:linear-gradient(90deg,#6b7280,#9ca3af); color:#eee; box-shadow:none;
      cursor:not-allowed; opacity:.95;
    }
    #claimButton[disabled]{
      background:linear-gradient(90deg,#6b7280,#9ca3af);
      color:#eee; box-shadow:none; cursor:not-allowed; opacity:.95; pointer-events:none;
    }
    #claimButton:not([disabled]){
      background:linear-gradient(90deg,#39ff14,#00ffa3);
      color:#000; box-shadow:0 0 20px rgba(57,255,20,.35);
      cursor:pointer;
    }
    #claimButton::before{
      content:""; position:absolute; top:-60%; left:-60%; width:220%; height:220%;
      background:radial-gradient(circle,rgba(255,255,255,.22) 0%, transparent 60%);
      transform:rotate(35deg); animation:shine 3s infinite; pointer-events:none;
    }
    @keyframes shine{0%{transform:translate(-60%,-60%) rotate(35deg)}100%{transform:translate(60%,60%) rotate(35deg)}}

    .claim-timer{color:#8ec7ff; margin-top:10px}
    .claim-success{color:#bfe0ff; margin-top:10px; font-weight:700; display:none}
    .claim-hash{color:#aab3c9; margin-top:8px; font-size:12px; display:none; word-break:break-all}

    .faq{width:min(520px,94vw); margin:34px auto 12px}
    .faq h2{text-align:center; font-size:22px; color:#8ec7ff; text-shadow:0 0 8px rgba(99,179,237,.4); margin-bottom:14px}
    .faq-item{background:rgba(255,255,255,.05); border-radius:12px; padding:16px 18px; color:#dde6ff; margin-bottom:12px}

    .footer{
      width:100%; text-align:center; color:#a9b8d8; font-size:12px;
      margin-top:24px; padding-bottom:72px;
    }
    .links a{color:#8ec7ff; text-decoration:none; margin:0 10px}
    .links a:hover{text-shadow:0 0 8px rgba(142,199,255,.8)}

    #cookieConsent{position:fixed; bottom:0; width:100%; background:rgba(20,20,40,.95); color:#fff; text-align:center; padding:15px 20px; display:none; z-index:1000; box-shadow:0 -2px 10px rgba(0, 136, 255, .3)}
    #acceptCookiesButton{margin-top:10px; padding:8px 16px; border-radius:8px; border:none; background:linear-gradient(90deg,#2b6cb0,#63b3ed); color:#000; font-weight:bold; cursor:pointer;}

    /* LOADING overlay (pós-login) */
    .loading{
      position:fixed; inset:0; width:100%; height:100dvh;
      z-index:9998; display:none; place-items:center;
      backdrop-filter: blur(6px);
      background: radial-gradient(1000px 600px at 50% -10%, rgba(99,179,237,.12), transparent 70%);
      animation:loadingFadeIn .2s ease-out;
    }
    .loading.show{display:grid;}
    @keyframes loadingFadeIn{ from{opacity:0} to{opacity:1} }

    .loading-wrap{
      width:clamp(150px, 22vmin, 260px); aspect-ratio:1/1; position:relative;
      transform:translateY(-7vh);
      animation:loadingPop .45s cubic-bezier(.2,.8,.2,1)
    }
    @media (max-width: 480px){
      .loading-wrap{ transform:translateY(-5vh); }
    }
    @keyframes loadingPop{ from{transform:translateY(-7vh) scale(.92); opacity:.6} to{transform:translateY(-7vh) scale(1); opacity:1} }
    .loading svg{width:100%; height:100%}
    .loading .outline{stroke:url(#loadStroke); stroke-width:7; fill:none; stroke-linejoin:round; filter:drop-shadow(0 8px 20px rgba(99,179,237,.25))}
    .loading .dash{stroke:#8ec7ff; stroke-width:3; fill:none; stroke-dasharray:18 70; animation:loadDash 1.9s linear infinite}
    @keyframes loadDash{ to{ stroke-dashoffset:-120 } }
    .loading .v{fill:url(#loadStroke); animation:pulse 1.9s ease-in-out infinite}
    .loading .v:nth-child(1){animation-delay:0s}
    .loading .v:nth-child(2){animation-delay:.15s}
    .loading .v:nth-child(3){animation-delay:.3s}
    .loading .v:nth-child(4){animation-delay:.45s}
    .loading .v:nth-child(5){animation-delay:.6s}
    .loading .v:nth-child(6){animation-delay:.75s}
    @keyframes pulse{ 0%,100%{transform:scale(1)} 50%{transform:scale(1.18)} }
  
    /* Neon active state for Quiz Claim button */
    #quizPanel #quizClaimBtn.quiz-claim-active{
      background: linear-gradient(90deg, #22c55e, #86efac);
      color:#052e16; font-weight:800;
      border:none;
      box-shadow: 0 0 16px rgba(34,197,94,.75), 0 0 32px rgba(134,239,172,.45);
      text-shadow: 0 0 6px rgba(255,255,255,.35);
    }
    
/* v9c: strict removal of scrollbars in quiz modal */
#quizModal {
  overflow: hidden !important;
  max-height: 100vh !important;
  max-width: 100vw !important;
}
#quizModal .quiz-card {
  overflow: visible !important;
  max-height: none !important;
  max-width: 100% !important;
  padding-right: 20px;
  box-sizing: border-box;
}
#quizModal, #quizModal * {
  scrollbar-width: none !important;
}
#quizModal::-webkit-scrollbar,
#quizModal *::-webkit-scrollbar {
  display: none !important;
}

</style>
</head>
<body>

<!-- INTRO -->
<div class="intro" id="intro" aria-hidden="true">
  <svg width="0" height="0" aria-hidden="true">
    <defs>
      <linearGradient id="introStroke" x1="0" y1="0" x2="1" y2="1">
        <stop offset="0%" stop-color="#2b6cb0"/><stop offset="100%" stop-color="#63b3ed"/>
      </linearGradient>
      <clipPath id="introClip">
        <path id="introHex" d="M120 36 L193 78 L193 162 L120 204 L47 162 L47 78 Z"/>
      </clipPath>
    </defs>
  </svg>
  <div class="intro-wrap">
    <svg viewBox="0 0 240 240" role="img" aria-label="Balbi hex introduction">
      <use href="#introHex" class="hx-outline"></use>
      <use href="#introHex" class="dash"></use>
      <circle class="vertex" cx="120" cy="36" r="6"/>
      <circle class="vertex" cx="193" cy="78" r="6"/>
      <circle class="vertex" cx="193" cy="162" r="6"/>
      <circle class="vertex" cx="120" cy="204" r="6"/>
      <circle class="vertex" cx="47"  cy="162" r="6"/>
      <circle class="vertex" cx="47"  cy="78"  r="6"/>
      <image href="logo1.png" x="72" y="70" width="96" height="96" preserveAspectRatio="xMidYMid meet" clip-path="url(#introClip)"/>
    </svg>
  </div>
</div>

<!-- LOADING pós-login -->
<div class="loading" id="loadingOverlay" aria-hidden="true">
  <svg width="0" height="0" aria-hidden="true">
    <defs>
      <linearGradient id="loadStroke" x1="0" y1="0" x2="1" y2="1">
        <stop offset="0%" stop-color="#2b6cb0"/><stop offset="100%" stop-color="#63b3ed"/>
      </linearGradient>
      <clipPath id="loadClip">
        <path id="loadHex" d="M120 36 L193 78 L193 162 L120 204 L47 162 L47 78 Z"/>
      </clipPath>
    </defs>
  </svg>
  <div class="loading-wrap">
    <svg viewBox="0 0 240 240" role="img" aria-label="Loading">
      <use href="#loadHex" class="outline"></use>
      <use href="#loadHex" class="dash"></use>
      <circle class="v" cx="120" cy="36" r="6"/>
      <circle class="v" cx="193" cy="78" r="6"/>
      <circle class="v" cx="193" cy="162" r="6"/>
      <circle class="v" cx="120" cy="204" r="6"/>
      <circle class="v" cx="47"  cy="162" r="6"/>
      <circle class="v" cx="47"  cy="78"  r="6"/>
      <image href="logo1.png" x="72" y="70" width="96" height="96" preserveAspectRatio="xMidYMid meet" clip-path="url(#loadClip)"/>
    </svg>
  </div>
</div>

<!-- BG hex com vértices -->
<div class="hex-drift" aria-hidden="true">
  <svg width="0" height="0" aria-hidden="true">
    <defs>
      <linearGradient id="hexStroke" x1="0" y1="0" x2="1" y2="1">
        <stop offset="0%" stop-color="#2b6cb0"/><stop offset="100%" stop-color="#63b3ed"/>
      </linearGradient>
      <symbol id="hexSymbol" viewBox="0 0 200 200">
        <polygon points="100,10 185,55 185,145 100,190 15,145 15,55"
                 fill="none" stroke="url(#hexStroke)" stroke-width="2" stroke-linejoin="round"/>
        <circle cx="100" cy="10"  r="5" fill="url(#hexStroke)"/>
        <circle cx="185" cy="55"  r="5" fill="url(#hexStroke)"/>
        <circle cx="185" cy="145" r="5" fill="url(#hexStroke)"/>
        <circle cx="100" cy="190" r="5" fill="url(#hexStroke)"/>
        <circle cx="15"  cy="145" r="5" fill="url(#hexStroke)"/>
        <circle cx="15"  cy="55"  r="5" fill="url(#hexStroke)"/>
      </symbol>
    </defs>
  </svg>
  <div class="hex h1"><svg viewBox="0 0 200 200"><use href="#hexSymbol"/></svg></div>
  <div class="hex h2"><svg viewBox="0 0 200 200"><use href="#hexSymbol"/></svg></div>
  <div class="hex h3"><svg viewBox="0 0 200 200"><use href="#hexSymbol"/></svg></div>
  <div class="hex h4"><svg viewBox="0 0 200 200"><use href="#hexSymbol"/></svg></div>
</div>

<div class="layer">
  <div class="card">
    <div class="hero">
      <div class="logo-wrap">
        <svg viewBox="0 0 240 240" aria-hidden="true">
          <defs>
            <linearGradient id="stroke" x1="0" y1="0" x2="1" y2="1">
              <stop offset="0%" stop-color="#2b6cb0"/><stop offset="100%" stop-color="#63b3ed"/>
            </linearGradient>
            <clipPath id="clipHex"><path id="hexPath" d="M120 36 L193 78 L193 162 L120 204 L47 162 L47 78 Z"/></clipPath>
          </defs>
          <use href="#hexPath" class="hx-main"></use>
          <use href="#hexPath" class="hx-dash"></use>
          <g>
            <circle class="vertex" cx="120" cy="36" r="6"/>
            <circle class="vertex" cx="193" cy="78" r="6"/>
            <circle class="vertex" cx="193" cy="162" r="6"/>
            <circle class="vertex" cx="120" cy="204" r="6"/>
            <circle class="vertex" cx="47"  cy="162" r="6"/>
            <circle class="vertex" cx="47"  cy="78"  r="6"/>
          </g>
          <image href="logo1.png" x="72" y="70" width="96" height="96" preserveAspectRatio="xMidYMid meet" clip-path="url(#clipHex)"/>
        </svg>
      </div>
      <h1 class="title">Balbi Faucet</h1>
      <p class="subtitle">Enter your private key to access your wallet. Your data is not stored.</p>
    </div>

    <!-- Honeypots contra autofill -->
    <input type="text" autocomplete="username" tabindex="-1" aria-hidden="true" style="position:absolute;left:-9999px;opacity:0;height:0;width:0;border:0;padding:0">
    <input type="password" autocomplete="current-password" tabindex="-1" aria-hidden="true" style="position:absolute;left:-9999px;opacity:0;height:0;width:0;border:0;padding:0">

    <div id="loginSection">
      <input
        type="text"
        id="privateKeyInput"
        placeholder="Your private key here (0x...)"
        inputmode="text"
        autocomplete="off"
        autocapitalize="off"
        spellcheck="false"
        name="pk_field"
      >
      <button id="connectButton" type="button">Access Wallet</button>
    </div>

    <div id="walletAddress" class="wallet-address" style="display:none;">
      <span>Wallet Address:</span>
      <div id="addressDisplay"></div>
      <button id="logoutButton" type="button">Log Out</button>
    </div>

    <div id="walletInfo" style="display:none;">

      <!-- ======= Faucet PRIMEIRO ======= -->
      <div class="panel" style="margin-top:14px;">
        <h2>Faucet</h2>
        <p>Claim Balbi every 4 hours and help the ecosystem grow.</p>
        <button id="claimButton" type="button" disabled>Claim Balbi</button>
        <div id="claimTimer" class="claim-timer"></div>
        <div id="claimSuccess" class="claim-success">Tokens sent successfully!</div>
        <div id="claimHash" class="claim-hash" style="display:none;"></div>
      </div>

      <!-- Balances -->
      <div class="panel" style="margin-top:14px;">
        <h2>Balances</h2>
        <p class="tiny-note" style="margin-top:6px;font-size:11px;color:#ccc;opacity:.6">⏳ Note: balance may take a moment to update after a claim.</p>
        <div class="balance-item">
          <span>BALBI Balance</span>
          <span id="balbiBalance" class="balance-value">...</span>
        </div>
        <div class="balance-item">
          <span>USDC Balance</span>
          <span id="usdcBalance"  class="balance-value">...</span>
        </div>
      </div>

      <!-- ======= Quiz DEPOIS ======= -->
      <div class="panel" id="quizPanel" style="margin-top:14px;">
        <h2>Quiz — Play & Earn</h2>
        <p>Up to <strong>3 rounds</strong> per 4-hour window. Each passed round (≥60 pts) adds
           <strong>0.06–0.10 BALBI</strong> to your quiz balance based on score. You can claim the accumulated
           quiz balance once per 4 hours.</p>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button id="openQuizBtn" type="button" style="background:linear-gradient(90deg,var(--accent),var(--accent2));color:#000;font-weight:800;border:none;border-radius:12px;padding:10px 14px;box-shadow:0 0 16px rgba(99,179,237,.65),0 0 30px rgba(99,179,237,.25);text-shadow:0 0 6px rgba(255,255,255,.35);">Play Quiz</button>
          <button id="quizClaimBtn" type="button" style="background:rgba(255,255,255,.06);color:#e6eefb;border:1px solid #335aa833;border-radius:12px;padding:10px 14px;box-shadow:0 0 12px rgba(46,105,189,.35);">Claim 0.0 BALBI</button>
        </div>
        <div id="quizRoundInfo" class="claim-timer" style="margin-top:6px;">Rounds this window: 0/3</div>
        <div id="quizClaimTimer" class="claim-timer"></div>
        <div id="quizClaimMsg" class="claim-success" style="display:none;"></div>
        <div id="quizClaimHash" class="claim-hash" style="display:none;"></div>
      </div>

      <p style="margin-top:16px;">
        <a class="links" href="https://dapp.quickswap.exchange/swap/v3/0x3c499c542cEF5E3811e1192ce70d8cC03d5c3359/0x619B0fcDcb30a45091745Fb12C9640237bbF27c5?chainId=137" target="_blank" style="color:#8ec7ff;text-decoration:none;">
          Swap on Quickswap
        </a>
      </p>
    </div>
  </div>
</div>

<div class="faq">
  <h2>Frequently Asked Questions</h2>
  <div class="faq-item">
    <h3>How often can I claim Balbi?</h3>
    <p>You can claim tokens every 4 hours. This ensures fair distribution for all users.</p>
  </div>
  <div class="faq-item">
    <h3>Is this wallet secure?</h3>
    <p>Yes. The entered private key is not stored on our server. Login is performed only in your browser.</p>
  </div>
  <div class="faq-item">
    <h3>Are there any fees?</h3>
    <p>The wallet is completely free. You only pay the standard blockchain network fees (gas fees) for transactions.</p>
  </div>
</div>

<div class="footer">
  <div class="links">
    <a href="terms.html">Terms of Service</a>
    <a href="privacy.html">Privacy Policy</a>
    <a href="https://polygonscan.com/token/0x619B0fcDcb30a45091745Fb12C9640237bbF27c5" target="_blank">View Contract</a>
  </div>
  <div>© 2025 Balbi Faucet. Built with ❤️ for the crypto community.</div>
</div>

<div id="cookieConsent">
  <p>We use cookies to store your private key locally and improve your experience. By continuing, you agree to our Privacy Policy.</p>
  <button id="acceptCookiesButton" type="button">Accept</button>
</div>

<!-- Garante input vazio -->
<script>
  try { localStorage.removeItem('balbiPrivateKey'); } catch(e) {}
  document.addEventListener('DOMContentLoaded', ()=>{
    const pk = document.getElementById('privateKeyInput');
    if (pk) pk.value = '';
  });
</script>

<!-- Carrega seu front-end -->
<script>
  const s=document.createElement('script');
  s.src='faucet-frontend.js?v=' + Date.now();
  document.head.appendChild(s);
</script>

<!-- Mostra loading ao clicar e mantém por ~1.2s; esconde ao logar -->
<script>
  (function(){
    const overlay = document.getElementById('loadingOverlay');
    const connectBtn = document.getElementById('connectButton');
    const addrBox = document.getElementById('addressDisplay');
    const walletBox = document.getElementById('walletAddress');

    function showOverlay(){
      if (!overlay) return;
      overlay.classList.add('show');
      overlay.dataset.start = String(Date.now());
    }
    function hideOverlay(){
      if (!overlay) return;
      const start = Number(overlay.dataset.start || Date.now());
      const minShow = 1200; // ~1.2s mínimo
      const elapsed = Date.now() - start;
      setTimeout(()=> overlay.classList.remove('show'), Math.max(0, minShow - elapsed));
    }

    if (connectBtn){
      connectBtn.addEventListener('click', ()=>{
        showOverlay();
        // segurança: garante que some em até 12s, mesmo se algo travar
        setTimeout(()=> overlay.classList.remove('show'), 12000);
      });
    }

    const obs = new MutationObserver(()=>{
      const hasAddr = addrBox && addrBox.textContent && addrBox.textContent.trim().length > 0;
      const isShown = walletBox && getComputedStyle(walletBox).display !== 'none';
      if (hasAddr && isShown){
        hideOverlay();
      }
    });
    if (addrBox) obs.observe(addrBox, { childList:true, subtree:true, characterData:true });
    if (walletBox) obs.observe(walletBox, { attributes:true, attributeFilter:['style','class'] });
  })();
</script>

<!-- Defs reutilizados -->
<svg width="0" height="0" style="position:absolute" aria-hidden="true">
  <defs>
    <linearGradient id="hexStroke" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0%" stop-color="#2b6cb0"/><stop offset="100%" stop-color="#63b3ed"/>
    </linearGradient>
  </defs>
</svg>


  <!-- QUIZ MODAL -->
  <style>
    /* Scoped quiz styles */
    #quizModal{position:fixed; inset:0; z-index:9999; display:none; align-items:center; justify-content:center;
      background:rgba(6,10,24,.9); backdrop-filter:blur(6px);}
    #quizModal .quiz-card{box-shadow:0 0 22px rgba(99,179,237,.25), 0 16px 44px rgba(8,14,35,.55), inset 0 1px 0 rgba(255,255,255,.05);width:min(820px,94vw); background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.02));
      border:1px solid rgba(47,82,152,.35); box-shadow:0 16px 44px rgba(8,14,35,.55), inset 0 1px 0 rgba(255,255,255,.05);
      border-radius:18px; padding:20px; color:#e6eefb; font-family:Inter,system-ui,sans-serif; max-height:90vh; overflow:auto}
    #quizModal h3{margin:0 0 6px; font-size:22px; color:#8ec7ff}
    #quizModal p{margin:8px 0}
    #quizModal .qblock{box-shadow:0 0 22px rgba(99,179,237,.22), inset 0 0 0 1px rgba(47,82,152,.35);box-shadow:0 0 18px rgba(99,179,237,.18);margin:14px 0; padding:14px; border-radius:12px; background:rgba(255,255,255,.05); border:1px solid #2f529833}
    #quizModal .opts{display:grid; gap:10px; margin-top:8px}
    #quizModal button{padding:10px 14px; border-radius:10px; border:none; cursor:pointer}
    #quizModal .primary{background:linear-gradient(90deg,#2b6cb0,#63b3ed); color:#000; font-weight:800;box-shadow:0 0 16px rgba(99,179,237,.65), 0 0 32px rgba(99,179,237,.35);text-shadow:0 0 6px rgba(255,255,255,.4);}
    #quizModal .ghost{background:rgba(255,255,255,.06); color:#e6eefb; border:1px solid #335aa833;box-shadow:0 0 10px rgba(46,105,189,.35);}
    #quizModal .row{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
    #quizModal .score{font-weight:800; color:#8ec7ff}
    #quizModal .hint{color:#a5b4cf; font-style:italic; display:none; margin-top:6px}
    #quizModal .close-x{position:absolute; top:14px; right:16px; background:transparent; color:#e6eefb; border:none; font-size:18px; cursor:pointer}
    @media (max-width:520px){ #quizModal .row{flex-direction:column} }
  
    /* Neon active state for Quiz Claim button */
    #quizPanel #quizClaimBtn.quiz-claim-active{
      background: linear-gradient(90deg, #22c55e, #86efac);
      color:#052e16; font-weight:800;
      border:none;
      box-shadow: 0 0 16px rgba(34,197,94,.75), 0 0 32px rgba(134,239,172,.45);
      text-shadow: 0 0 6px rgba(255,255,255,.35);
    }
    </style>
<style>

  /* === Neon Theme (scoped) === */
  :root {
    --glow-color: #00ffcc;
    --secondary-glow: #ff00cc;
    --quiz-bg: rgba(255,255,255,0.05);
  }
  #quizModal .quiz-card{
    position: relative;
    background: linear-gradient(180deg, rgba(15,18,30,.6), rgba(15,18,30,.25));
    border: 1px solid rgba(0,255,204,.25);
    box-shadow: 0 20px 50px rgba(0,0,0,.6), 0 0 30px rgba(0,255,204,.15);
  }
  #quizModal .quiz-card::before{
    content:''; position:absolute; inset:-2px;
    border-radius:18px;
    background:
      radial-gradient(60% 60% at 50% 0%, rgba(0,255,204,.25), transparent 60%),
      radial-gradient(50% 50% at 0% 100%, rgba(255,0,204,.18), transparent 60%);
    filter: blur(12px);
    z-index:-1;
  }
  #quizModal h3{ color:#b3fff0; text-shadow:0 0 8px rgba(0,255,204,.35); }
  #quizModal .qblock{
    background: var(--quiz-bg);
    border: 1px solid rgba(0,255,204,.18);
    box-shadow: 0 0 24px rgba(0,255,204,.22), inset 0 0 0 1px rgba(47,82,152,.35);
  }
  #quizModal .opts button{
    background: linear-gradient(90deg, #00ffd0, #ff5ee1, #00ffd0);
    background-size: 200% 200%;
    color:#0a0f14; font-weight:800; border:none;
    box-shadow: 0 0 16px rgba(0,255,204,.55), 0 0 26px rgba(255,0,204,.25);
    transition: transform .15s ease;
    animation: neonShift 5s linear infinite;
  }
  #quizModal .opts button:hover{ transform: translateY(-1px) scale(1.01); }
  #quizModal .ghost{ color:#e6eefb; border:1px solid rgba(0,255,204,.15) }
  #quizModal #showHint{ background: rgba(255,255,255,.06); animation:none; color:#e6eefb }
  #quizModal .primary{
    background: linear-gradient(90deg, #00ffd0, #ff5ee1, #00ffd0) !important;
    background-size: 200% 200% !important;
    color:#0a0f14 !important; font-weight:800 !important; border:none !important;
    box-shadow: 0 0 18px rgba(0,255,204,.6), 0 0 32px rgba(255,0,204,.35) !important;
    animation: neonShift 5s linear infinite !important;
  }
  #quizModal .hint{ color:#9ddbd1 }
  @keyframes neonShift{
    0%{ background-position: 0% 50%; }
    50%{ background-position: 100% 50%; }
    100%{ background-position: 0% 50%; }
  }
  /* Panel buttons neon */
  #quizPanel #openQuizBtn{
    background: linear-gradient(90deg, var(--accent, #00ffd0), var(--accent2, #ff5ee1), var(--accent, #00ffd0)) !important;
    background-size: 200% 200% !important;
    color:#04130f !important; font-weight:800 !important; border:none !important; border-radius:12px !important;
    padding:10px 14px !important;
    box-shadow: 0 0 18px rgba(0,255,204,.6), 0 0 32px rgba(255,0,204,.35) !important;
    animation: neonShift 6s linear infinite !important;
  }
  /* Claim button green when active (override inline with !important) */
  #quizPanel #quizClaimBtn.quiz-claim-active{
    background: linear-gradient(90deg, #22c55e, #86efac, #22c55e) !important;
    background-size: 200% 200% !important;
    color:#052e16 !important; font-weight:800 !important;
    border:none !important; border-radius:12px !important;
    box-shadow: 0 0 18px rgba(34,197,94,.75), 0 0 38px rgba(134,239,172,.55) !important;
    animation: neonShift 6s linear infinite !important;
  }

</style>
  <div id="quizModal" role="dialog" aria-modal="true" aria-label="Balbi Quiz">
    <div class="quiz-card">
      <button class="close-x" id="quizCloseBtn" title="Close">✕</button>
      <div id="quizStage">
        <!-- Filled by script -->
      </div>
    </div>
  </div>

  <script>
  (function(){

    const REPLIT_URL_QUIZ = 'https://74caa2ca-fab9-4e76-a1f0-3e32c4aaf7a4-00-lt9t4bvht6p6.spock.replit.dev'; // same backend as faucet
    const addressEl = document.getElementById('addressDisplay');
    const openBtn = document.getElementById('openQuizBtn');
    const claimBtn = document.getElementById('quizClaimBtn');
    const roundInfo = document.getElementById('quizRoundInfo');
    const claimTimer = document.getElementById('quizClaimTimer');
    const claimMsg = document.getElementById('quizClaimMsg');
    const claimHash = document.getElementById('quizClaimHash');
    const modal = document.getElementById('quizModal');
    const stage = document.getElementById('quizStage');
    const closeBtn = document.getElementById('quizCloseBtn');

    // LocalStorage keys
    function keys(addr){
      return {
        window: `quizWindow_${addr}`,
        accum: `quizAccum_${addr}`,
        lastClaim: `quizLastClaimTime_${addr}`
      };
    }
    const FOUR_H = 4 * 60 * 60 * 1000;

    // --- Randomness memory per window (STRICT: no repeats until the whole pool is used) ---
    function qMemKey(addr, wStart){ return `quizQMem_${addr}_${wStart}`; }
    function readQMem(addr, wStart){
      try { return JSON.parse(localStorage.getItem(qMemKey(addr,wStart))) || []; } catch(e){ return []; }
    }
    function writeQMem(addr, wStart, arr){
      localStorage.setItem(qMemKey(addr,wStart), JSON.stringify(arr.slice(0, 2000)));
    }

    function drawUniqueIndicesStrict(addr, wStart, poolLen, n){
      // current used set for this 4h window
      let used = new Set(readQMem(addr, wStart));
      // If we already used the entire pool, reset
      if (used.size >= poolLen) used = new Set();

      // Build available list
      const available = [];
      for (let i=0;i<poolLen;i++){
        if (!used.has(i)) available.push(i);
      }

      // If available < n, reset used and make all available
      let pickFrom = available;
      if (pickFrom.length < n){
        used = new Set();
        pickFrom = Array.from({length: poolLen}, (_,i)=>i);
      }

      // Fisher-Yates shuffle then take n
      for (let i = pickFrom.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [pickFrom[i], pickFrom[j]] = [pickFrom[j], pickFrom[i]];
      }
      const chosen = pickFrom.slice(0, n);

      // Update memory
      for (const c of chosen) used.add(c);
      writeQMem(addr, wStart, Array.from(used));
      return chosen;
    }

    function now(){ return Date.now(); }
    function getAddr(){ return (addressEl && addressEl.textContent || '').trim(); }
    function readJSON(key, def){ try { return JSON.parse(localStorage.getItem(key)) ?? def; } catch(e){ return def; } }
    function writeJSON(key, val){ localStorage.setItem(key, JSON.stringify(val)); }

    function getWindow(addr){
      const k = keys(addr).window;
      let w = readJSON(k, null);
      if(!w || (now() - w.start) >= FOUR_H) {
        w = { start: now(), count: 0 };
        writeJSON(k, w);
      }
      return w;
    }
    function incWindowCount(addr){
      const k = keys(addr).window;
      let w = getWindow(addr);
      w.count = (w.count || 0) + 1;
      writeJSON(k, w);
      return w.count;
    }
    function getAccum(addr){ return Number(localStorage.getItem(keys(addr).accum) || '0'); }
    function setAccum(addr, v){ localStorage.setItem(keys(addr).accum, String(Math.max(0, Number(v)||0))); }
    function addAccum(addr, v){ setAccum(addr, getAccum(addr) + Number(v||0)); }
    function getLastClaim(addr){ return Number(localStorage.getItem(keys(addr).lastClaim) || '0'); }
    function setLastClaim(addr, t){ localStorage.setItem(keys(addr).lastClaim, String(t)); }
    function fmt(n){ return (Math.round(n*100)/100).toFixed(2); }

    function updateUI(){
      const addr = getAddr();
      const w = getWindow(addr);
      roundInfo.textContent = `Rounds this window: ${(w.count||0)}/3`;
      const accum = getAccum(addr);
      claimBtn.textContent = `Claim ${fmt(accum)} BALBI`;
      const blocked = getClaimTimeLeft(addr) > 0;
      const canClaim = (accum > 0) && !blocked;
      claimBtn.disabled = !canClaim;
      if(canClaim) claimBtn.classList.add('quiz-claim-active');
      else claimBtn.classList.remove('quiz-claim-active');
      claimTimer.textContent = renderClaimTimerText(addr);
    }

    function getClaimTimeLeft(addr){
      const last = getLastClaim(addr);
      if(!last) return 0;
      const left = last + FOUR_H - now();
      return Math.max(0, left);
    }
    function renderClaimTimerText(addr){
      const left = getClaimTimeLeft(addr);
      if(left <= 0) return '';
      const h = Math.floor(left / 3600000);
      const m = Math.floor((left % 3600000)/60000);
      const s = Math.floor((left % 60000)/1000);
      return `Next quiz claim in: ${h}h ${m}m ${s}s`;
    }
    let tick = null;
    function startTick(){ if(tick) clearInterval(tick); tick = setInterval(updateUI, 1000); }

    // === 50 UNIQUE HVAC QUESTIONS (EN) ===
    const QUESTIONS = [
      { t:`Commercial building with stale air and odors; minimum OA only.`, ok:`Increase outdoor air to ASHRAE targets and rebalance to improve IAQ.`, w1:`Reduce OA to save energy and keep current balance.`, w2:`Use a refrigerant safety standard to set minimum ventilation.`, hint:`Proper OA and balance drive IAQ.` },
      { t:`Hospital shows mold due to high humidity; HVAC doesn’t control RH.`, ok:`Dehumidify supply air and keep RH < 60% with dedicated control.`, w1:`Raise only temperature setpoint and ignore RH.`, w2:`Use an energy standard to pick one RH for critical spaces.`, hint:`Treat humidity directly; mold risk rises >~60% RH.` },
      { t:`Oversized ducts cause uneven distribution and noise.`, ok:`Resize using recognized duct methods (e.g., static regain/SMACNA) and rebalance.`, w1:`Add more fans in series without revising ductwork.`, w2:`Use electrical code to pick air duct sizes.`, hint:`Sizing + TAB fixes the root cause.` },
      { t:`Refrigerant selection includes high-GWP options.`, ok:`Prioritize lower-GWP refrigerant, ensuring safety, efficiency, and compatibility.`, w1:`Pick the highest GWP for lowest CAPEX.`, w2:`Use occupancy ventilation rules to approve refrigerant type.`, hint:`Balance sustainability and safety.` },
      { t:`High-rise building with unwanted infiltration.`, ok:`Adjust zone pressures (slightly positive in clean zones) and improve airtightness.`, w1:`Tape windows without revising setpoints/balancing.`, w2:`Determine pressures from comfort standard only.`, hint:`Pressure relationships matter.` },
      { t:`Data center racks show hotspots.`, ok:`Implement hot/cold aisle containment and seal bypass.`, w1:`Only increase CRAC setpoint.`, w2:`Randomly add perforated tiles.`, hint:`Airflow management beats brute force.` },
      { t:`Office has comfort variation across zones.`, ok:`Use zoned control (e.g., commissioned VAV) and proper diffusion.`, w1:`Upsize the central unit for entire floor.`, w2:`Rely on a single return sensor for the whole floor.`, hint:`More local control = more comfort.` },
      { t:`School uses low-efficiency filters; IAQ is poor.`, ok:`Adopt MERV 13 where feasible and ensure proper sealing/seating.`, w1:`Lower filtration efficiency to reduce pressure drop.`, w2:`Use refrigerant safety class to choose MERV.`, hint:`Filtration reduces particles significantly.` },
      { t:`Industrial system with recurring refrigerant leaks.`, ok:`Leak detection program, records, and elimination of root cause.`, w1:`Periodically top up and keep operating.`, w2:`Use minimum OA rules to define acceptable leakage.`, hint:`Leaks are not “normal operations.”` },
      { t:`Theater disturbed by HVAC noise.`, ok:`Use duct silencers, proper diffusion, and controlled velocities.`, w1:`Increase airflow to “mask” noise.`, w2:`Apply a residential noise target to a theater.`, hint:`Treat acoustics in the air path.` },
      { t:`Cold room uses too much energy; poor insulation and seals.`, ok:`Improve insulation and door management (seals/air curtains).`, w1:`Increase compressor capacity only.`, w2:`Use comfort standard to select cold-room panels.`, hint:`Reduce thermal losses first.` },
      { t:`Lab has insufficient ACH for volatile contaminants.`, ok:`Increase air changes and provide dedicated exhaust/capture.`, w1:`Deodorize and keep ACH as is.`, w2:`Use energy standard to set minimum exhaust.`, hint:`Safety first: source capture & ACH.` },
      { t:`Hotel rooms have inconsistent temperatures.`, ok:`Provide room-level thermostats/zones and perform TAB.`, w1:`Single setpoint for the whole building.`, w2:`Use ventilation rates to control guest setpoints.`, hint:`Individual control improves experience.` },
      { t:`Mall corridors smell cooking odors from food court.`, ok:`Resize hood/exhaust/ducts and balance pressures.`, w1:`Only increase general mall OA.`, w2:`Use fluid safety classification to size Type I hoods.`, hint:`Kitchens need dedicated exhaust.` },
      { t:`Gym windows condensation due to high RH.`, ok:`Dehumidify supply air and adjust diffusion/temps.`, w1:`Increase OA only without treating RH.`, w2:`Use building efficiency standard to set gym RH.`, hint:`Attack moisture; OA alone may not fix.` },
      { t:`Cleanroom needs particle and pressure control.`, ok:`Maintain positive differential and HEPA filtration; tight doors/seals.`, w1:`Use MERV 8 and keep doors open “for more ventilation”.`, w2:`Use fluid safety code to define ISO class.`, hint:`Pressure + HEPA = baseline.` },
      { t:`Library has cold drafts on occupants.`, ok:`Reposition diffusers and reduce terminal velocities.`, w1:`Reduce outdoor air rate.`, w2:`Use ammonia refrigeration code for diffuser selection.`, hint:`Proper diffusion avoids drafts.` },
      { t:`Meeting rooms with high CO₂ during peaks.`, ok:`Adopt CO₂-based DCV and balance minimums.`, w1:`Only raise temp setpoint.`, w2:`Use fluid safety class to set CO₂ targets.`, hint:`DCV matches IAQ to occupancy.` },
      { t:`Ground-floor lobby gets infiltration from door cycling.`, ok:`Vestibule/air curtain and slight positive interior pressure; seals working.`, w1:`Make interior negative to “pull air in.”`, w2:`Use fluid safety code to compute infiltration.`, hint:`Control door airflows.` },
      { t:`Reception area smells from nearby restrooms.`, ok:`Provide adequate dedicated restroom exhaust and check traps.`, w1:`Perfume and reduce exhaust to save energy.`, w2:`Use comfort standard to set toilet exhaust.`, hint:`Dirty spaces need directional airflow.` },
      { t:`Tall auditorium with thermal stratification.`, ok:`Destratification/high returns and uniform supply.`, w1:`Lower global setpoint without changing diffusion.`, w2:`Use OA minimum formula to size stage height.`, hint:`Treat stratification with airflow design.` },
      { t:`Small IT room with a server hotspot.`, ok:`Duct cold air to load and seal bypass openings.`, w1:`Add heater to “balance” temperature.`, w2:`Use energy code to place racks.`, hint:`Bring air to where it’s needed.` },
      { t:`Residence has odors rising from basement via stairs.`, ok:`Light exhaust in basement, seal penetrations, auto-closing door.`, w1:`Pressurize living room negative.`, w2:`Use fluid safety class for basement exhaust rate.`, hint:`Pressure gradient solves migration.` },
      { t:`Gym air feels heavy after peak hours.`, ok:`Increase ACH, improve filtration, and use DCV/purge.`, w1:`Close OA intakes to save energy.`, w2:`Use fluid safety class to choose MERV.`, hint:`High bioeffluent needs renewal.` },
      { t:`Parking garage ventilation design.`, ok:`Use CO/NO₂ sensors to modulate fans and meet code purge rates.`, w1:`Rely on a fixed low speed at all times.`, w2:`Use comfort temperature standard to set garage ACH.`, hint:`Demand-control by gas sensors.` },
      { t:`Commercial kitchen fire/grease risk.`, ok:`Type I hoods with proper CFM, grease-rated ducts, and suppression.`, w1:`General OA alone will capture grease.`, w2:`Comfort standard determines hood class.`, hint:`Grease capture ≠ general ventilation.` },
      { t:`Indoor pool (natatorium) corrosion and odor.`, ok:`Maintain ~50–60% RH, supply to deck, exhaust at surface, slight negative to adjacent spaces.`, w1:`Max OA with no dehumidification.`, w2:`Use office comfort targets for pool RH.`, hint:`Specialized airflow + dehumidification.` },
      { t:`Airborne isolation room design.`, ok:`Negative pressure with anteroom and HEPA-filtered exhaust.`, w1:`Positive pressure to corridors.`, w2:`Use general office ACH as the sole criterion.`, hint:`Containment needs negative pressure.` },
      { t:`Operating room pressurization.`, ok:`Positive to corridors with HEPA and tight control of temp/RH.`, w1:`Neutral to corridors to save energy.`, w2:`Use parking-garage rules for ACH.`, hint:`ORs are kept positive & clean.` },
      { t:`Battery-charging room with hydrogen risk.`, ok:`Provide dedicated exhaust high in the space per charging rate; minimize ignition sources.`, w1:`Rely only on general OA of the building.`, w2:`Use comfort cooling standard to size exhaust.`, hint:`Ventilate at the top; consider H₂.` },
      { t:`Warehouse heating bills high; stratification.`, ok:`Use HVLS/destrat fans and adjust supply strategy.`, w1:`Raise supply temp only.`, w2:`Turn off returns completely.`, hint:`Mix layers to reduce losses.` },
      { t:`Heat pump frosting in winter.`, ok:`Ensure proper airflow and defrost cycle; clear drains/placement.`, w1:`Disable defrost to avoid interruptions.`, w2:`Run on continuous max speed.`, hint:`Defrost is intended behavior.` },
      { t:`OA economizer not reducing cooling load.`, ok:`Enable enthalpy-based economizer with high-limit and proper sensors.`, w1:`Economizer fixed open year-round.`, w2:`Economizer never allowed to open.`, hint:`Use free cooling when conditions allow.` },
      { t:`Consider heat recovery on DOAS.`, ok:`Use ERV/HRV to reduce OA load while maintaining IAQ.`, w1:`Bypass ERV to avoid any added pressure drop.`, w2:`Use only recirculation; remove OA.`, hint:`Recovery saves energy with IAQ.` },
      { t:`Cooling coil fouling, rising ΔP and poor capacity.`, ok:`Clean coils, keep upstream filtration, and verify ΔP and airflow.`, w1:`Increase chilled-water temp only.`, w2:`Remove filters to lower pressure drop.`, hint:`Dirty coils = lost capacity.` },
      { t:`VAV boxes “hunting.”`, ok:`Commission: tune PID, verify minimum flows, and static-pressure reset.`, w1:`Lock all boxes at maximum.`, w2:`Disable feedback from boxes.`, hint:`Control tuning + good setpoints.` },
      { t:`Pumps oversized; poor control.`, ok:`Trim impeller or use VFD; balance; implement DP reset.`, w1:`Throttle discharge valve permanently.`, w2:`Run constant speed at 100%.`, hint:`Right-size or vary the speed.` },
      { t:`Chilled-water ΔT is too low (“low ΔT syndrome”).`, ok:`Fix bypassing, valve authority, coil reset, and balance flows.`, w1:`Increase primary flow endlessly.`, w2:`Close all bypasses and all valves.`, hint:`Address coil performance & control.` },
      { t:`High condenser-water approach temp.`, ok:`Clean towers/condensers, ensure treatment and design flow.`, w1:`Raise chiller lift permanently.`, w2:`Disable tower fans.`, hint:`Heat rejection needs maintenance.` },
      { t:`VRF and refrigerant concentration limit (RCL).`, ok:`Ensure RCL compliance (volume/leak detection/segmentation).`, w1:`Ignore volume; RCL applies only to chillers.`, w2:`Rely on open windows as mitigation.`, hint:`Check room volume vs charge.` },
      { t:`High duct leakage found on test.`, ok:`Upgrade sealing class, repair leaks, and re-test TAB.`, w1:`Increase fan speed to compensate.`, w2:`Ignore unless comfort complaints arise.`, hint:`Leakage = wasted capacity/energy.` },
      { t:`Stair pressurization for smoke control.`, ok:`Pressurize stairs positive with relief paths; verify door opening forces.`, w1:`Negative stairwell to pull smoke out.`, w2:`Seal stairs airtight and over-pressurize.`, hint:`Keep smoke out; doors still operable.` },
      { t:`UFAD has hotspots and weak throw.`, ok:`Adjust diffuser layout, loads, and plenum sealing; verify supply temps.`, w1:`Switch to ceiling return only.`, w2:`Block floor diffusers randomly.`, hint:`Plenum tightness & layout matter.` },
      { t:`Radiant floor overheating complaints.`, ok:`Use mixing valve, floor sensors, and reset curves.`, w1:`Raise boiler temp.`, w2:`Disable thermostatic control.`, hint:`Limit surface temperature smartly.` },
      { t:`Thermostats installed near supply/solar gain.`, ok:`Relocate or average sensors away from drafts/solar.`, w1:`Hide sensors behind curtains.`, w2:`Use return sensor only.`, hint:`Sensors must reflect occupied zone.` },
      { t:`BAS has no schedules or optimum start.`, ok:`Implement occupancy schedules, night setback, and optimum start/stop.`, w1:`Run at occupied mode 24/7.`, w2:`Disable all scheduling to avoid errors.`, hint:`Scheduling saves a lot.` },
      { t:`Boilers short-cycling at low loads.`, ok:`Add buffer volume, stage boilers, and reset SWT.`, w1:`Force both boilers on always.`, w2:`Disable staging logic.`, hint:`Longer, fewer cycles are better.` },
      { t:`HPWH in tight mechanical room.`, ok:`Provide make-up air and manage cooling effect on room.`, w1:`Seal the room completely.`, w2:`Exhaust all air to outdoors with no intake.`, hint:`HPWH cools the room; plan airflow.` },
      { t:`Rooftop unit nuisance trips.`, ok:`Verify rotation/phasing, airflow proving (filters/fans), freezestat, and low-ambient kits.`, w1:`Bypass safeties to keep it running.`, w2:`Oversize fuses only.`, hint:`Safeties trip for real reasons.` },
      { t:`DOAS sizing for classrooms.`, ok:`Size OA by people + area; use MERV 13; ensure supply/relief paths.`, w1:`Size only by floor area.`, w2:`Eliminate OA to reduce cost.`, hint:`Both people and area count.` }
    ];

    function shuffle(a){ return a.map(v=>({v, r:Math.random()})).sort((x,y)=>x.r-y.r).map(e=>e.v); }

    function openModal(){ modal.style.display = 'flex'; renderStart(); }
    function closeModal(){ modal.style.display = 'none'; }
    function ensureLogin(){
      const addr = getAddr();
      if(!addr){ alert('Please connect your wallet first.'); return false; }
      return true;
    }

    openBtn.addEventListener('click', ()=>{
      if(!ensureLogin()) return;
      const addr = getAddr();
      const w = getWindow(addr);
      if((w.count||0) >= 3){
        alert('Limit reached: wait until the current 4-hour window resets.');
        return;
      }
      openModal();
    });
    closeBtn.addEventListener('click', closeModal);

    // stages
    let currentIdx = 0;
    let score = 0;
    let roundQs = [];

    function renderStart(){
      currentIdx = 0; score = 0;
      roundQs = [];
      const addrX = getAddr();
      const wX = getWindow(addrX);
      const drawn = drawUniqueIndicesStrict(addrX, wX.start, QUESTIONS.length, 5);
      for(const di of drawn){ roundQs.push(QUESTIONS[di]); }
      stage.innerHTML = `
        <h3>Balbi Quiz — Round</h3>
        <p>Answer 5 quick questions. ≥60 points grants a reward. Each correct = 20 pts.</p>
        <div class="row">
          <button id="beginRound" class="primary">Start Round</button>
          <button id="cancelRound" class="ghost">Cancel</button>
        </div>`;
      document.getElementById('beginRound').onclick = ()=> renderQuestion(0);
      document.getElementById('cancelRound').onclick = closeModal;
    }

    function renderQuestion(i){
      currentIdx = i;
      const q = roundQs[i];
      const opts = shuffle([
        {k:'a', txt:q.ok, ok:true},
        {k:'b', txt:q.w1, ok:false},
        {k:'c', txt:q.w2, ok:false},
      ]);
      stage.innerHTML = `
        <h3>Question ${i+1}/5</h3>
        <div class="qblock">
          <p>${q.t}</p>
          <div class="opts">
            ${opts.map((o,idx)=>`<button class="ghost" data-idx="${idx}">${o.txt}</button>`).join('')}
          </div>
          <button id="showHint" class="ghost" style="margin-top:8px">Show hint</button>
          <div id="hint" class="hint">${q.hint||''}</div>
        </div>
        <div class="row">
          <button id="quit" class="ghost">Quit</button>
        </div>`;
      stage.querySelectorAll('.opts button').forEach((btn,idx)=>{
        btn.onclick = ()=>{ handleAnswer(opts[idx].ok); };
      });
      document.getElementById('showHint').onclick = ()=>{ const h = document.getElementById('hint'); h.style.display = 'block'; };
      document.getElementById('quit').onclick = closeModal;
    }

    function handleAnswer(ok){
      if(ok) score += 20;
      const next = currentIdx + 1;
      if(next < 5) renderQuestion(next);
      else renderResult();
    }

    // >>> AJUSTE DE PREMIAÇÃO: 0.06/0.07/0.08/0.09/0.10 <<<
    function rewardFromScore(sc){
      if (sc < 60) return 0;
      if (sc >= 100) return 0.10;
      const tens = Math.floor(sc / 10); // 60->6, 70->7, 80->8, 90->9
      return Math.min(0.10, tens / 100); // 6→0.06, 7→0.07, 8→0.08, 9→0.09
    }

    function renderResult(){
      const addr = getAddr();
      const w = getWindow(addr);
      const reward = rewardFromScore(score);
      const passed = reward > 0;
      if(passed) addAccum(addr, reward);
      incWindowCount(addr);
      updateUI();

      stage.innerHTML = `
        <h3>Round Complete</h3>
        <p class="score">Score: ${score}/100</p>
        <p>${passed ? `+ ${fmt(reward)} BALBI added to your quiz balance.` : 'Score below 60 — no reward this round.'}</p>
        <div class="row">
          <button id="playAgain" class="primary">Play Another Round</button>
          <button id="close" class="ghost">Close</button>
        </div>`;
      document.getElementById('playAgain').onclick = ()=>{
        const w2 = getWindow(addr);
        if((w2.count||0) >= 3){
          alert('Limit reached for this 4-hour window.');
          closeModal();
          return;
        }
        renderStart();
      };
      document.getElementById('close').onclick = closeModal;
    }

    // Claim logic (usar mesmo endpoint do faucet)
    claimBtn.addEventListener('click', async ()=>{
      const addr = getAddr();
      if(!addr){ alert('Please connect your wallet first.'); return; }
      const amount = getAccum(addr);
      if(!(amount>0)) return;

      claimBtn.disabled = true;
      claimMsg.style.display = 'none';
      claimHash.style.display = 'none';
      claimBtn.textContent = 'Claiming...';

      function toWeiStr(x){
        const s = (Math.round(x*100)/100).toFixed(2);
        const parts = s.split('.');
        const intp = parts[0];
        const fracp = (parts[1] || '00');
        const frac2 = (fracp + '00').slice(0,2);
        return intp + frac2 + '0000000000000000'; // 10^(18-2)
      }
      const amountWei = toWeiStr(amount);

      try {
        const res = await fetch((REPLIT_URL_QUIZ || '') + '/claim', {  /* <<< ÚNICA MUDANÇA AQUI */
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            address: addr,
            amount_decimals: 18,
            amount_wei: amountWei,
            amount: Number(amount.toFixed(2)),
            source: 'quiz'
          }),
          mode: 'cors',
          credentials: 'omit'
        });
        const data = await res.json().catch(()=>({}));
        if(!res.ok){
          throw new Error(data && data.error ? data.error : 'quiz-claim rejected');
        }
        setLastClaim(addr, now());
        setAccum(addr, 0);
        claimMsg.textContent = 'Quiz tokens sent successfully!';
        claimMsg.style.display = 'block';
        if(data && data.txHash){
          claimHash.textContent = 'Tx Hash: ' + data.txHash;
          claimHash.style.display = 'block';
        }
      } catch(e){
        claimMsg.textContent = 'Quiz claim failed: ' + (e.message || 'unknown error') + '. '
          + 'Your backend must implement POST /quiz-claim and honor the passed amount.';
        claimMsg.style.display = 'block';
      } finally {
        claimBtn.textContent = `Claim ${fmt(getAccum(getAddr()))} BALBI`;
        updateUI();
      }
    });

    function initOnce(){ updateUI(); startTick(); }

    // Observe wallet visibility / address changes para atualizar UI e LIMPAR HASH DO QUIZ em novo login
    const walletBox = document.getElementById('walletAddress');
    let lastAddrSeen = '';
    function clearQuizTxUI(){
      if (claimMsg){ claimMsg.style.display='none'; claimMsg.textContent=''; }
      if (claimHash){ claimHash.style.display='none'; claimHash.textContent=''; }
    }
    function checkAddrChange(){
      const cur = getAddr();
      if (cur !== lastAddrSeen){
        lastAddrSeen = cur;
        clearQuizTxUI(); // << limpar hash/msg do quiz ao trocar de carteira
      }
    }
    const obs2 = new MutationObserver(()=>{
      updateUI();
      checkAddrChange();
    });
    if(addressEl) obs2.observe(addressEl, { childList:true, subtree:true, characterData:true });
    if(walletBox) obs2.observe(walletBox, { attributes:true, attributeFilter:['style','class'] });

    document.addEventListener('DOMContentLoaded', initOnce);
    updateUI();
    initOnce();

  })(); 
  </script>

</body>
</html>
