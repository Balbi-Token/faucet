<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BalbiCO2</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="bg-gray-100 font-sans">

<!-- LOGIN -->
<div id="login-page" class="min-h-screen flex items-center justify-center">
  <div class="bg-white p-8 rounded shadow-md w-full max-w-md">
    <h2 class="text-2xl font-bold mb-6 text-center">Login / Criar Carteira</h2>
    <input id="user-name" type="text" placeholder="Seu nome" class="border p-2 w-full mb-4 rounded">
    <input id="user-email" type="email" placeholder="Seu e-mail" class="border p-2 w-full mb-4 rounded">
    <button id="login-btn" class="bg-blue-600 text-white w-full p-2 rounded hover:bg-blue-700">Criar Carteira / Login</button>
  </div>
</div>

<!-- DASHBOARD -->
<div id="dashboard-page" class="hidden min-h-screen p-8">
  <h2 class="text-2xl font-bold mb-4">Dashboard</h2>
  <div class="mb-6">
    <p>Saldo MCO2: <span id="saldo-mco2">0</span></p>
    <p>Saldo BALBI: <span id="saldo-balbi">0</span></p>
  </div>
  <div class="space-x-4">
    <button id="btn-calculadora" class="bg-green-600 text-white p-2 rounded hover:bg-green-700">Calculadora de Pegada</button>
    <button id="btn-carteira" class="bg-yellow-600 text-white p-2 rounded hover:bg-yellow-700">Carteira</button>
    <a href="https://quickswap.exchange/#/swap?outputCurrency=0xSeuTokenBALBI" target="_blank" class="bg-purple-600 text-white p-2 rounded hover:bg-purple-700">Get BALBI</a>
  </div>
</div>

<!-- CALCULADORA -->
<div id="calculadora-page" class="hidden min-h-screen p-8">
  <h2 class="text-2xl font-bold mb-4">Calculadora de Pegada</h2>
  <form id="calc-form" class="space-y-4 max-w-md">
    <input type="number" id="distancia" placeholder="Distância percorrida (km)" class="border p-2 w-full rounded">
    <input type="number" id="energia" placeholder="Consumo de energia (kWh)" class="border p-2 w-full rounded">
    <button type="button" id="btn-gerar-pdf" class="bg-blue-600 text-white p-2 rounded hover:bg-blue-700">Gerar Relatório PDF</button>
  </form>
  <button id="btn-voltar-dash" class="mt-6 bg-gray-600 text-white p-2 rounded hover:bg-gray-700">Voltar ao Dashboard</button>
</div>

<!-- CARTEIRA -->
<div id="carteira-page" class="hidden min-h-screen p-8">
  <h2 class="text-2xl font-bold mb-4">Minha Carteira</h2>
  <p>Saldo MCO2: <span id="carteira-mco2">0</span></p>
  <p>Saldo BALBI: <span id="carteira-balbi">0</span></p>
  <button id="btn-refresh-saldo" class="mt-4 bg-blue-600 text-white p-2 rounded hover:bg-blue-700">Atualizar Saldo</button>
  <button id="btn-voltar-dash2" class="mt-4 bg-gray-600 text-white p-2 rounded hover:bg-gray-700">Voltar ao Dashboard</button>
</div>

<script>
  // Variáveis globais
  let carteiraEnd = '';
  let saldoMCO2 = 0;
  let saldoBALBI = 0;

  // Páginas
  const loginPage = document.getElementById('login-page');
  const dashboardPage = document.getElementById('dashboard-page');
  const calculadoraPage = document.getElementById('calculadora-page');
  const carteiraPage = document.getElementById('carteira-page');

  const loginBtn = document.getElementById('login-btn');

  // FUNÇÕES DE BACKEND
  async function createWallet(email) {
    try {
      const res = await fetch('/create-wallet', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email })
      });
      const data = await res.json();
      if (data.success) return data.walletaddress;
      else throw new Error(data.error || 'Erro ao criar carteira');
    } catch (err) {
      alert(err.message);
    }
  }

  async function getBalance(wallet) {
    try {
      const res = await fetch('/check-balance', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ wallet })
      });
      const data = await res.json();
      if (data.success) return parseFloat(data.balance);
      else throw new Error(data.error || 'Erro ao consultar saldo');
    } catch (err) {
      alert(err.message);
      return 0;
    }
  }

  // LOGIN
  loginBtn.addEventListener('click', async () => {
    const name = document.getElementById('user-name').value;
    const email = document.getElementById('user-email').value;
    if (!name || !email) { alert('Preencha nome e e-mail'); return; }

    const walletAddress = await createWallet(email);
    if (!walletAddress) return;

    carteiraEnd = walletAddress;
    saldoMCO2 = await getBalance(walletAddress);
    saldoBALBI = 0;

    document.getElementById('saldo-mco2').innerText = saldoMCO2;
    document.getElementById('saldo-balbi').innerText = saldoBALBI;

    alert(`Carteira criada!\nEndereço: ${carteiraEnd}\nChave privada enviada por e-mail`);
    loginPage.classList.add('hidden');
    dashboardPage.classList.remove('hidden');
  });

  // NAVEGAÇÃO DASHBOARD → PÁGINAS
  document.getElementById('btn-calculadora').addEventListener('click', () => {
    dashboardPage.classList.add('hidden');
    calculadoraPage.classList.remove('hidden');
  });
  document.getElementById('btn-carteira').addEventListener('click', () => {
    dashboardPage.classList.add('hidden');
    carteiraPage.classList.remove('hidden');
    document.getElementById('carteira-mco2').innerText = saldoMCO2;
    document.getElementById('carteira-balbi').innerText = saldoBALBI;
  });

  // VOLTAR AO DASHBOARD
  document.getElementById('btn-voltar-dash').addEventListener('click', () => {
    calculadoraPage.classList.add('hidden');
    dashboardPage.classList.remove('hidden');
  });
  document.getElementById('btn-voltar-dash2').addEventListener('click', () => {
    carteiraPage.classList.add('hidden');
    dashboardPage.classList.remove('hidden');
  });

  // REFRESH SALDO
  document.getElementById('btn-refresh-saldo').addEventListener('click', async () => {
    saldoMCO2 = await getBalance(carteiraEnd);
    document.getElementById('carteira-mco2').innerText = saldoMCO2;
    alert('Saldo atualizado!');
  });

  // GERAR PDF - Calculadora
  document.getElementById('btn-gerar-pdf').addEventListener('click', () => {
    const distancia = document.getElementById('distancia').value || 0;
    const energia = document.getElementById('energia').value || 0;
    const pegada = (distancia * 0.21 + energia * 0.5).toFixed(2); // Exemplo simples

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.setFontSize(16);
    doc.text("Relatório de Pegada de Carbono", 20, 20);
    doc.setFontSize(12);
    doc.text(`Distância percorrida: ${distancia} km`, 20, 40);
    doc.text(`Consumo de energia: ${energia} kWh`, 20, 50);
    doc.text(`Pegada calculada: ${pegada} kgCO₂`, 20, 60);
    doc.text(`Carteira: ${carteiraEnd}`, 20, 70);

    doc.save("Relatorio_Pegada_CO2.pdf");
  });
</script>
</body>
</html>
